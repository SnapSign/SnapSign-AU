# DecoDocs AI Analysis - Architecture & Data Flow

## System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          DECODOCS WEB APPLICATION                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                     USER INTERFACE LAYER                            â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚  â”‚ DocumentViewer (Main Component)                             â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ PDF Display (PDFDisplay.jsx)                           â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ AnalysisToolbox.jsx âš™ï¸ (6 action buttons)            â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Type-specific analysis âœ…                          â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Legacy analysis âœ… (Gemini callable active)       â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Explain Selection âœ… (backend implemented)        â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Highlight Risks âœ… (backend implemented)          â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Translate to Plain English âœ… (backend impl.)     â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€ Summarize/Improvements âŒ (no dedicated logic)    â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ AnalysisSidebar.jsx (Results display)                â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€ Risk Badges (Not rendering - needs implementation)  â”‚   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                     HOOK LAYER                                       â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚  â”‚ useDocumentAnalysis                                        â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ handleAnalyzeDocument()                              â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  â”‚   â””â”€ calls: analyzeTextCall()                        â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ handleAnalyzeByType()                               â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  â”‚   â””â”€ calls: analyzeByTypeCall()                      â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ handleExplainSelection() âš ï¸                        â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  â”‚   â””â”€ calls: explainSelection() [contract mismatch]  â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ handleHighlightRisks() âš ï¸                          â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  â”‚   â””â”€ calls: highlightRisks() [contract mismatch]    â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€ handleTranslateToPlainEnglish() âš ï¸                â”‚     â”‚    â”‚
â”‚  â”‚  â”‚      â””â”€ calls: translateToPlainEnglish() [mismatch]    â”‚     â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                     SERVICE LAYER                                    â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚  â”‚ Service Callables (Firebase)                             â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ analyzeTextCall() âœ… (wrapper)                      â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ analyzeByTypeCall() âœ… (wrapper)                   â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ preflightCheckCall() âœ… (wrapper)                  â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€ [Storage services]                                  â”‚     â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ HTTP Calls
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FIREBASE CLOUD FUNCTIONS (BACKEND)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    CALLABLE FUNCTIONS                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ analyzeText âœ… (GEMINI IMPLEMENTED)                           â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Input: { docHash, stats, text, options }               â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Process: Calls Gemini with structured JSON schema     â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Build analysis prompt                              â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Parse Gemini response                              â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€ Extract risks, obligations, etc.                   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Output: Analysis results                              â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ ğŸŸ¡ ACTION NEEDED: Contract/docs/tests alignment       â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ analyzeByType âœ… (Gemini-backed; testing/hardening remaining) â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Input: { docHash, text }                                â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Process: Type-specific analysis with Gemini            â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Output: Validation against type schema                 â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ ğŸŸ¡ ACTION NEEDED: Complete Gemini integration          â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ explainSelection âœ… (IMPLEMENTED)                             â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Input: { docHash, selection, documentContext }         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Process: Call Gemini to explain clause                â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Output: Plain English explanation                      â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ ğŸŸ¡ ACTION NEEDED: Frontend response contract alignmentâ”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ highlightRisks âœ… (IMPLEMENTED)                               â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Input: { docHash, documentText, documentType }         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Process: Call Gemini to identify risky clauses         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Output: Risk locations, severity, recommendations      â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ ğŸŸ¡ ACTION NEEDED: Normalize risk field mapping        â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ translateToPlainEnglish âœ… (IMPLEMENTED)                     â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Input: { docHash, legalText }                          â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Process: Call Gemini to translate legal language      â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Output: Plain English translation                      â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ ğŸŸ¡ ACTION NEEDED: Frontend response contract alignmentâ”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    SUPPORT FUNCTIONS                                â”‚   â”‚
â”‚  â”‚  â”œâ”€ preflightCheck âœ…                                             â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Security validation before analysis                      â”‚   â”‚
â”‚  â”‚  â”œâ”€ getUserEntitlement âœ…                                        â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Check tier (free/pro/anonymous)                         â”‚   â”‚
â”‚  â”‚  â”œâ”€ enforceTokenBudget âœ…                                       â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Check usage limits                                      â”‚   â”‚
â”‚  â”‚  â””â”€ [Other utilities]                                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    GEMINI API CLIENT âœ…                             â”‚   â”‚
â”‚  â”‚  â”œâ”€ getGeminiModel() in functions/lib/gemini-client.js          â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Build prompt via functions/lib/prompts.js                â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Call Gemini API                                          â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Parse JSON response                                      â”‚   â”‚
â”‚  â”‚  â”œâ”€ Structured schemas in functions/lib/analysis-schema.js      â”‚   â”‚
â”‚  â”‚  â””â”€ Token estimation/budgeting enforced server-side             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ API Calls
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           GOOGLE GEMINI API                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”œâ”€ Model: gemini-2.0-flash (fast) or gemini-2.0-pro (accurate)           â”‚
â”‚  â”œâ”€ Input: Prompts + document text                                         â”‚
â”‚  â”œâ”€ Output: JSON structured analysis                                       â”‚
â”‚  â””â”€ Status: âœ… INTEGRATED (further tuning and tests in progress)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FIRESTORE DATABASE                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”œâ”€ docshashes (ledger) âœ…                                                 â”‚
â”‚  â”‚  â””â”€ Track all analyzed documents                                        â”‚
â”‚  â”œâ”€ usage_events âœ…                                                        â”‚
â”‚  â”‚  â””â”€ Log token usage per user/tier                                       â”‚
â”‚  â”œâ”€ usage_tracking âœ…                                                      â”‚
â”‚  â”‚  â””â”€ Daily/lifetime totals                                              â”‚
â”‚  â””â”€ [Other collections]                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow: Document Analysis

```
User Action: Click "Analyze Document"
    â”‚
    â”œâ”€â–º Frontend: DocumentViewer Component
    â”‚    â”œâ”€ Captures PDF text (via usePdfJs)
    â”‚    â”œâ”€ Gets document metadata (size, pages, etc.)
    â”‚    â””â”€ Calls: handleAnalyzeDocument()
    â”‚
    â”œâ”€â–º Hook: useDocumentAnalysis.handleAnalyzeDocument()
    â”‚    â”œâ”€ Validates: PDF loaded, user authenticated
    â”‚    â”œâ”€ Calls: runPreflightCheck() â†’ preflightCheckCall()
    â”‚    â”‚   â””â”€ Validates: Not scanned, document legal, no safety issues
    â”‚    â”œâ”€ Calculates: Token budget needed
    â”‚    â””â”€ Calls: analyzeTextCall()
    â”‚
    â”œâ”€â–º Service: analyzeTextCall()
    â”‚    â””â”€ Firebase callable wrapper
    â”‚
    â”œâ”€â–º Backend Function: exports.analyzeText
    â”‚    â”œâ”€ Validates: Auth, input format
    â”‚    â”œâ”€ Gets: User tier (free/pro/anonymous)
    â”‚    â”œâ”€ Enforces: Token budget check
    â”‚    â”œâ”€ âœ… CURRENT: Calls Gemini API
    â”‚    â”œâ”€ ğŸŸ¡ NEXT: finalize contract mapping and output consistency
    â”‚    â”‚   â”œâ”€ Build analysis prompt
    â”‚    â”‚   â”œâ”€ Call gemini-2.0-flash model
    â”‚    â”‚   â”œâ”€ Parse JSON response
    â”‚    â”‚   â””â”€ Extract:
    â”‚    â”‚      â”œâ”€ Plain explanation
    â”‚    â”‚      â”œâ”€ High/medium/low risks
    â”‚    â”‚      â”œâ”€ Unfair conditions
    â”‚    â”‚      â”œâ”€ Inconsistencies
    â”‚    â”‚      â”œâ”€ Obligations
    â”‚    â”‚      â””â”€ Missing information
    â”‚    â”œâ”€ Records: Usage event to Firestore
    â”‚    â””â”€ Returns: Analysis results + usage info
    â”‚
    â”œâ”€â–º Frontend: Receives results
    â”‚    â”œâ”€ AnalysisSidebar: Displays summary
    â”‚    â”œâ”€ Risks: Shows risk list with severity
    â”‚    â””â”€ UI: Updates analysis state
    â”‚
    â””â”€â–º User: Sees analysis results
         â”œâ”€ Can click on risks for details
         â”œâ”€ Can view recommendations
         â””â”€ Can try other analysis tools
```

---

## Remaining AI Work - Implementation Order

### Priority 1: Contract + UI Alignment (CRITICAL)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Align frontend handlers to backend `ok`   â”‚
â”‚ Location: useDocumentAnalysis.js          â”‚
â”‚ Effort: 2-4h                              â”‚
â”‚ Blocker: explain/highlight/translate UX   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Priority 2: Finalize Existing Core Features (CRITICAL)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ explainSelection (Contract alignment)      â”‚
â”‚ Location: hooks + backend response docs    â”‚
â”‚ Effort: 1-2h                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ highlightRisks (Risk field normalization)  â”‚
â”‚ Location: hooks + renderer mapping         â”‚
â”‚ Effort: 1-2h                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ translateToPlainEnglish (Contract align)   â”‚
â”‚ Location: hooks + backend response docs    â”‚
â”‚ Effort: 1-2h                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Priority 3: Complete Existing (HIGH)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ analyzeByType (final hardening)           â”‚
â”‚ Location: functions/index.js:1215        â”‚
â”‚ Effort: 4h                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Status Legend

- âœ… **Complete & Working**
- ğŸŸ¡ **Partial / Stubbed**
- âŒ **Missing / Not Implemented**
- ğŸ”´ **Critical Issue**
- ğŸŸ  **High Priority**
- ğŸ”µ **Nice to Have**

---

## File Structure - What Exists vs. What's Missing

```
functions/
â”œâ”€ index.js
â”‚  â”œâ”€ âœ… analyzeText (line 317)
â”‚  â”‚  â””â”€ âœ… Gemini callable active
â”‚  â”œâ”€ ğŸŸ¡ analyzeByType (line 1215)
â”‚  â”‚  â””â”€ ğŸŸ  Gemini active; final hardening pending
â”‚  â”œâ”€ âœ… explainSelection
â”‚  â”œâ”€ âœ… highlightRisks
â”‚  â”œâ”€ âœ… translateToPlainEnglish
â”‚  â””â”€ âœ… [Other functions: preflight, storage, etc.]
â”œâ”€ lib/
â”‚  â”œâ”€ âœ… auth.js
â”‚  â”œâ”€ âœ… entitlement.js
â”‚  â”œâ”€ âœ… storage-access.js
â”‚  â”œâ”€ âœ… billing/
â”‚  â”œâ”€ âœ… gemini-client.js
â”‚  â”œâ”€ âœ… prompts.js
â”‚  â””â”€ âœ… analysis-schema.js
â””â”€ test/
   â”œâ”€ âœ… [Existing tests]
   â””â”€ ğŸŸ¡ analysis function coverage expansion in progress

Decodocs/web/src/
â”œâ”€ hooks/
â”‚  â”œâ”€ âœ… useDocumentAnalysis.js
â”‚  â”‚  â”œâ”€ âœ… handleAnalyzeDocument
â”‚  â”‚  â”œâ”€ âœ… handleAnalyzeByType
â”‚  â”‚  âš ï¸ handleExplainSelection
â”‚  â”‚  â”‚  â””â”€ ğŸ”´ Response contract alignment needed (`ok` vs `success`)
â”‚  â”‚  âš ï¸ handleHighlightRisks
â”‚  â”‚  â”‚  â””â”€ ğŸ”´ Contract/field mapping alignment needed
â”‚  â”‚  â””â”€ âœ… handleTranslateToPlainEnglish
â”‚  â””â”€ âœ… useTextSelection.js
â”œâ”€ components/
â”‚  â”œâ”€ âœ… AnalysisToolbox.jsx
â”‚  â”‚  â””â”€ ğŸ”´ summary/improvements buttons still need dedicated wiring
â”‚  â”œâ”€ âœ… AnalysisSidebar.jsx
â”‚  â”œâ”€ âœ… DocumentViewer.jsx
â”‚  â”‚  â””â”€ ğŸ”´ Risk badges not rendering
â”‚  â””â”€ âœ… [Current overlays rendered through PDF renderer hooks]
â””â”€ services/
   â”œâ”€ âœ… analyzeTextService.js
   â”œâ”€ âœ… typeAnalysisService.js
   â”œâ”€ âœ… preflightService.js
   â””â”€ ğŸŸ¡ no dedicated explain/risk/translate service files yet (handled in hook)
```

---

## Gemini API Integration Points

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        GEMINI API INTEGRATION            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  Initialize:                            â”‚
â”‚  â”œâ”€ import GoogleGenerativeAI          â”‚
â”‚  â”œâ”€ create client with API key         â”‚
â”‚  â””â”€ select model (flash or pro)        â”‚
â”‚                                         â”‚
â”‚  For Each Analysis Type:                â”‚
â”‚  â”œâ”€ Build custom prompt                â”‚
â”‚  â”œâ”€ Set JSON schema (structured output)â”‚
â”‚  â”œâ”€ Call generateContent()             â”‚
â”‚  â”œâ”€ Parse JSON response                â”‚
â”‚  â””â”€ Validate against schema            â”‚
â”‚                                         â”‚
â”‚  Error Handling:                        â”‚
â”‚  â”œâ”€ Retry on network error             â”‚
â”‚  â”œâ”€ Fallback to basic analysis         â”‚
â”‚  â”œâ”€ Log usage metrics                  â”‚
â”‚  â””â”€ Track costs/quota                  â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Token Budget System (Already Implemented âœ…)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           TOKEN BUDGET SYSTEM            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  Anonymous Users:                        â”‚
â”‚  â””â”€ 20,000 tokens total (no reset)      â”‚
â”‚                                          â”‚
â”‚  Free Tier:                              â”‚
â”‚  â””â”€ 40,000 tokens per day (UTC)         â”‚
â”‚                                          â”‚
â”‚  Pro Tier:                               â”‚
â”‚  â””â”€ Unlimited tokens                    â”‚
â”‚                                          â”‚
â”‚  Tracking:                               â”‚
â”‚  â”œâ”€ Per UID (daily rolling)             â”‚
â”‚  â”œâ”€ Per document hash (permanent)       â”‚
â”‚  â””â”€ Stored in Firestore                 â”‚
â”‚                                          â”‚
â”‚  Enforcement:                            â”‚
â”‚  â”œâ”€ Estimate tokens before API call     â”‚
â”‚  â”œâ”€ Check budget allows request         â”‚
â”‚  â”œâ”€ Block if insufficient tokens        â”‚
â”‚  â””â”€ Record actual usage after call      â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Next Document:** Review [AI_ANALYSIS_IMPLEMENTATION_PLAN.md](AI_ANALYSIS_IMPLEMENTATION_PLAN.md)
