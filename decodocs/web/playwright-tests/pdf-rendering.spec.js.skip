import { test, expect } from '@playwright/test';

test.describe('PDF Rendering Test', () => {
  test.beforeEach(async ({ page }) => {
    // Navigate to the document viewer page
    await page.goto('/view');
  });

  test('should render PDF properly on at least 80% of the screen', async ({ page }) => {
    // Wait for the page to load
    await page.waitForLoadState('networkidle');

    // Check if we can access the test PDF
    await page.goto('/view/test-docs/dummy.pdf');
    
    // Wait for potential PDF loading
    await page.waitForTimeout(3000);

    // Check if there's a PDF viewer element
    const pdfViewer = await page.$('[data-testid="pdf-viewer"], .pdf-viewer, #pdf-container, .react-pdf, .pdf-document');
    
    if (pdfViewer) {
      // Check dimensions of the PDF viewer
      const box = await pdfViewer.boundingBox();
      
      // Get viewport dimensions
      const viewportSize = page.viewportSize();
      
      // Calculate percentage of screen used
      const screenArea = viewportSize.width * viewportSize.height;
      const viewerArea = box.width * box.height;
      const percentageOfScreen = (viewerArea / screenArea) * 100;
      
      console.log(`PDF viewer occupies ${percentageOfScreen.toFixed(2)}% of screen`);
      
      // Assert that PDF viewer occupies at least 80% of screen
      expect(percentageOfScreen).toBeGreaterThanOrEqual(80);
      
      // Additional checks for PDF content visibility
      const pdfPages = await page.$$('.react-pdf__Page, .pdf-page, [data-testid="pdf-page"]');
      expect(pdfPages.length).toBeGreaterThan(0);
    } else {
      // If no specific PDF viewer element found, check for iframe or object tag
      const pdfElements = await page.$$('iframe[src*=".pdf"], object[data*=".pdf"], embed[src*=".pdf"]');
      expect(pdfElements.length).toBeGreaterThan(0);
      
      if (pdfElements.length > 0) {
        const box = await pdfElements[0].boundingBox();
        const viewportSize = page.viewportSize();
        const screenArea = viewportSize.width * viewportSize.height;
        const elementArea = box.width * box.height;
        const percentageOfScreen = (elementArea / screenArea) * 100;
        
        console.log(`PDF element occupies ${percentageOfScreen.toFixed(2)}% of screen`);
        expect(percentageOfScreen).toBeGreaterThanOrEqual(80);
      }
    }
  });

  test('should handle direct PDF opening', async ({ page }) => {
    // Test opening a PDF directly via URL parameter
    await page.goto('/');
    
    // Look for the Open PDF button
    const openPdfButton = await page.locator('button:has-text("Open PDF"), button:has-text("Open PDF Document")');
    await expect(openPdfButton).toBeVisible();
    
    // Click the Open PDF button
    await openPdfButton.click();
    
    // Wait for potential file dialog or navigation
    await page.waitForTimeout(2000);
    
    // At this point, we'd normally select a file, but for testing purposes
    // we'll navigate directly to the test PDF
    await page.goto('https://decodocs-site.web.app/view/test-docs/dummy.pdf');
    
    // Verify the page loaded without errors
    await expect(page).toHaveURL(/.*\/view.*/);
    
    // Check for error messages
    const errorElements = await page.$$('.error, .error-message, [data-testid="error"]');
    expect(errorElements.length).toBe(0);
  });
});